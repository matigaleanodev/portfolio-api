name: CI - Build, Push & Deploy API

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: matigaleanodev/portfolio-api
  APP_DIR: /home/ec2-user/infra/apps/portfolio

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: matigaleanodev
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build & Push (sha + latest)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy on EC2 (docker compose)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd ${{ env.APP_DIR }}

            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u matigaleanodev --password-stdin

            sed -i "s|^IMAGE=.*$|IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}|g" .env

            docker compose pull
            docker compose up -d
            docker image prune -f

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Cleanup old images (keep last 3 sha tags)
        if: success()
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          OWNER: matigaleanodev
          PACKAGE: portfolio-api
          KEEP: 3
        run: |
          set -e

          versions=$(curl -s \
            -H "Authorization: Bearer $GHCR_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/$OWNER/packages/container/$PACKAGE/versions?per_page=100")

          ids_to_delete=$(echo "$versions" | jq -r '
            [ .[]
              | select(.metadata.container.tags != null)
              | select([.metadata.container.tags[] | startswith("sha-")] | any)
              | {id: .id, tags: .metadata.container.tags}
            ]
            | map(select(.tags | any(startswith("sha-"))))
            | .['"$KEEP"':]
            | .[].id
          ')

          if [ -z "$ids_to_delete" ]; then
            echo "No old sha images to delete."
            exit 0
          fi

          echo "$ids_to_delete" | while read -r id; do
            echo "Deleting version id=$id"
            curl -s -X DELETE \
              -H "Authorization: Bearer $GHCR_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/users/$OWNER/packages/container/$PACKAGE/versions/$id" \
              >/dev/null
          done
